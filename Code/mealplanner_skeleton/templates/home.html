{% extends "base.html" %}
{% load form_extras %}

{% block content %}
<section class="grid md:grid-cols-2 gap-8">
  <!-- Left: Input form -->
  <div class="bg-white border rounded-xl p-5 shadow-sm">
    <h2 class="text-xl font-semibold mb-3">Your details</h2>
    <form method="post" class="grid grid-cols-2 gap-3">{% csrf_token %}
      <div class="col-span-2 mb-3">
        <p class="text-sm text-zinc-600">Estimated daily target: <strong>{{ preview_kcal }}</strong> kcal</p>
        <p class="text-xs text-zinc-400">You can optionally enter a Target calories value in the form to override this estimate.</p>
      </div>
      <div class="col-span-1">
        <label class="text-sm">Age</label>
        {{ form.age|add_class:"w-full border rounded px-3 py-2" }}
      </div>
      <div class="col-span-1">
        <label class="text-sm">Sex</label>
        {{ form.sex|add_class:"w-full border rounded px-3 py-2" }}
      </div>
      <div class="col-span-1">
        <label class="text-sm">Height (cm)</label>
        {{ form.height_cm|add_class:"w-full border rounded px-3 py-2" }}
      </div>
      <div class="col-span-1">
        <label class="text-sm">Weight (kg)</label>
        {{ form.weight_kg|add_class:"w-full border rounded px-3 py-2" }}
      </div>
      <div class="col-span-1">
        <label class="text-sm">Activity level</label>
        {{ form.activity|add_class:"w-full border rounded px-3 py-2" }}
      </div>
      <div class="col-span-1">
        <label class="text-sm">Goal</label>
        {{ form.goal|add_class:"w-full border rounded px-3 py-2" }}
      </div>
      <div class="col-span-1">
        <label class="text-sm">Target calories (optional)</label>
        {{ form.target_kcal|add_class:"w-full border rounded px-3 py-2" }}
      </div>
      <div class="col-span-2">
        <label class="text-sm">Diet notes (allergies, dislikes)</label>
        {{ form.diet_notes|add_class:"w-full border rounded px-3 py-2" }}
      </div>
      <div class="col-span-2">
        <button class="px-4 py-2 rounded bg-green-600 text-white">Generate plan</button>
      </div>
    </form>
  </div>

  <!-- Right: Latest plan -->
  <div class="bg-white border rounded-xl p-5 shadow-sm">
    <h2 class="text-xl font-semibold mb-3">Latest plan</h2>
    {% if request.session.last_generated_profile %}
      <div class="mb-3 text-sm text-zinc-600 border-l-4 pl-3 py-2 bg-white">
        <div class="font-medium">Last generated using:</div>
        <div class="text-xs">
          Age: {{ request.session.last_generated_profile.age }} • Sex: {{ request.session.last_generated_profile.sex }} • Height: {{ request.session.last_generated_profile.height_cm }} cm • Weight: {{ request.session.last_generated_profile.weight_kg }} kg
          <br>
          Activity: {{ request.session.last_generated_profile.activity }} • Goal: {{ request.session.last_generated_profile.goal }}
          {% if request.session.last_generated_profile.target_kcal %}
            • Target kcal: {{ request.session.last_generated_profile.target_kcal }}
          {% endif %}
        </div>
      </div>
    {% endif %}
    {% if plan %}
      <p class="text-sm text-zinc-600 mb-2">Days: {{ plan.days }} • Total kcal: {{ plan.total_kcal }} • Total €: {{ plan.total_price }}</p>
      <div class="max-h-80 overflow-auto">
        <div class="grid gap-4" style="grid-template-columns: repeat({{ plan.days }}, minmax(0, 1fr));">
          {% for day in plan_by_day %}
          <div class="border rounded p-3 bg-zinc-50">
            <h3 class="font-semibold mb-2">Day {{ day.day }}</h3>
            <ul class="space-y-2 text-sm">
              {% for meal in day.meals %}
                {% with nut=meal.recipe.nutrition_and_price %}
                <li class="p-2 border rounded bg-white">
                  <div class="font-medium">{{ meal.recipe.name }}</div>
                  <div class="text-xs text-zinc-600">
                    {% if meal.meal_type == "B" %}Breakfast{% elif meal.meal_type == "L" %}Lunch{% else %}Dinner{% endif %}
                    • {{ nut.kcal }} kcal • €{{ nut.price }}
                  </div>
                </li>
                {% endwith %}
              {% empty %}
                <li class="text-sm text-zinc-500">No meals</li>
              {% endfor %}
            </ul>
            <div class="mt-3 text-sm font-semibold">Day total: €{{ day.price }} • {{ day.kcal }} kcal</div>
          </div>
          {% endfor %}
        </div>
      </div>
    {% else %}
      <p class="text-sm text-zinc-600">No plan yet. Fill the form and click <em>Generate plan</em>.</p>
    {% endif %}
  </div>
</section>
{% endblock %}
